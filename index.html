<html>

<head>

<script id="vertexShader" type="notJs">
        precision mediump float; 
        attribute vec3 a_position;
        attribute vec2 a_texCoords;
        attribute vec3 a_normals;
        
        varying vec2 v_texCoords;
        varying vec3 v_surfaceNormal;
        varying vec3 v_lightVector;
        varying vec3 v_toCameraVector;
        varying float v_visibility;
        
        uniform mat4 u_transformationMatrix; 
        uniform mat4 u_projectionMatrix;
        uniform mat4 u_viewMatrix;
        uniform vec3 u_lightPosition;
        uniform mat4 u_inverseViewMatrix;
        uniform float u_fakeLighting;

        const float density  = 0.007;
        const float gradient = 1.5;

        
        void main() 
        {
            vec4 world = u_transformationMatrix * vec4(a_position,1.0);
            vec4 positionRelativeToCam = u_viewMatrix * world;
            gl_Position = u_projectionMatrix * positionRelativeToCam;
            v_texCoords = a_texCoords; 

            vec3 normal = a_normals;
            if(u_fakeLighting > 0.5){
                normal = vec3(0.0,1.0,0.0);
            }

            v_surfaceNormal = (u_transformationMatrix * vec4(normal, 0.0)).xyz;
            v_lightVector = u_lightPosition - world.xyz;
            v_toCameraVector = (u_inverseViewMatrix * vec4(0.0,0.0,0.0,1.0)).xyz - world.xyz;

            float distance = length( positionRelativeToCam.xyz);
            v_visibility = exp(-pow(distance * density, gradient));
            v_visibility = clamp(v_visibility, 0.0, 1.0);

        }
    </script>
    <script id="fragmentShader" type="notJs">
         precision mediump float;
         varying vec2 v_texCoords;
         varying vec3 v_surfaceNormal;
         varying vec3 v_lightVector;
         varying vec3 v_toCameraVector;
         varying float v_visibility;
         
         uniform vec3 u_lightColor;
         uniform sampler2D u_texture; 
         uniform float u_shineDamper;
         uniform float u_reflectivity;
         uniform vec3 u_skyColor;

         void main()
         {
         
            vec4 color = texture2D(u_texture,v_texCoords);
            vec3 unitSurfaceNormal = normalize(v_surfaceNormal);
            vec3 unitLightVector = normalize(v_lightVector);
            vec3 unitToCameraVector = normalize(v_toCameraVector);
            
            float nDotL = dot(unitSurfaceNormal, unitLightVector);
            float brightness = max(nDotL, 0.2);
            vec3 diffuse = brightness * u_lightColor;
            
            vec3 lightDirection = v_lightVector;
            vec3 reflectedLightDirection = reflect(lightDirection, unitSurfaceNormal);
            
            float specularFactor = dot(reflectedLightDirection, unitSurfaceNormal);
            specularFactor = max(specularFactor, 0.0);
            float dampedFactor = pow(specularFactor, u_shineDamper);
            vec3 finalSpecular = dampedFactor * u_lightColor * u_reflectivity;
            
            if(color.a < 0.5){
                discard;
            }
         
            gl_FragColor = vec4(diffuse, 1.0) * color  + vec4(finalSpecular, 1.0);
            gl_FragColor = mix(vec4(u_skyColor, 1.0), gl_FragColor, v_visibility);
         }
    </script>
      <script id="terrainVertexShader" type="notJs">
        precision mediump float; 
        attribute vec3 a_position;
        attribute vec2 a_texCoords;
        attribute vec3 a_normals;
        
        varying vec2 v_texCoords;
        varying vec3 v_surfaceNormal;
        varying vec3 v_lightVector;
        varying vec3 v_toCameraVector;
        varying float v_visibility;
        
        uniform mat4 u_transformationMatrix; 
        uniform mat4 u_projectionMatrix;
        uniform mat4 u_viewMatrix;
        uniform vec3 u_lightPosition;
        uniform mat4 u_inverseViewMatrix;

        const float gradient = 1.5;
        const float density = 0.007;
        
        
        void main() 
        {
            vec4 world = u_transformationMatrix * vec4(a_position,1.0);
            vec4 positionRelativeToCam = u_viewMatrix * world;
            gl_Position = u_projectionMatrix * positionRelativeToCam;
            v_texCoords = a_texCoords; 

            v_surfaceNormal = (u_transformationMatrix * vec4(a_normals, 0.0)).xyz;
            v_lightVector = u_lightPosition - world.xyz;
            v_toCameraVector = (u_inverseViewMatrix * vec4(0.0,0.0,0.0,1.0)).xyz - world.xyz;

            float distance = length(positionRelativeToCam.xyz);
            v_visibility = exp(-pow(distance * density, gradient));
            v_visibility = clamp(v_visibility, 0.0, 1.0);
        }
    </script>
    <script id="terrainFragmentShader" type="notJs">
         precision mediump float;
         varying vec2 v_texCoords;
         varying vec3 v_surfaceNormal;
         varying vec3 v_lightVector;
         varying vec3 v_toCameraVector;
         varying float v_visibility;
         
         uniform vec3 u_lightColor;
         uniform float u_shineDamper;
         uniform float u_reflectivity;
         uniform vec3 u_skyColor;

         uniform sampler2D u_backgroundTexture;
         uniform sampler2D u_redTexture;
         uniform sampler2D u_greenTexture;
         uniform sampler2D u_blueTexture;
         uniform sampler2D u_blendMapTexture;
         
         void main()
         {

            vec4 blendMapColor = texture2D(u_blendMapTexture, v_texCoords);

            float backTextureAmount = 1.0 - (blendMapColor.r + blendMapColor.g + blendMapColor.b);
            vec2 tiledCoords = v_texCoords * 120.0;

            vec4 backgroundTextureColor = texture2D(u_backgroundTexture, tiledCoords) * backTextureAmount;
            vec4 redTexture = texture2D(u_redTexture,  tiledCoords) * blendMapColor.r;
            vec4 greenTexture = texture2D(u_greenTexture,  tiledCoords) * blendMapColor.g;
            vec4 blueTexture = texture2D(u_blueTexture,  tiledCoords) * blendMapColor.b;

            vec4 totalColor = backgroundTextureColor + redTexture +  greenTexture + blueTexture;

            vec3 unitSurfaceNormal = normalize(v_surfaceNormal);
            vec3 unitLightVector = normalize(v_lightVector);
            vec3 unitToCameraVector = normalize(v_toCameraVector);
            
            float nDotL = dot(unitSurfaceNormal, unitLightVector);
            float brightness = max(nDotL, 0.2);
            vec3 diffuse = brightness * u_lightColor;
            
            vec3 lightDirection = v_lightVector;
            vec3 reflectedLightDirection = reflect(lightDirection, unitSurfaceNormal);
            
            float specularFactor = dot(reflectedLightDirection, unitToCameraVector);
            specularFactor = max(specularFactor, 0.0);
            float dampedFactor = pow(specularFactor, u_shineDamper);
            vec3 finalSpecular = dampedFactor * u_lightColor * u_reflectivity;
            
         
            gl_FragColor = vec4(diffuse, 1.0) * totalColor + vec4(finalSpecular, 1.0);
            gl_FragColor = mix(vec4(u_skyColor, 1.0), gl_FragColor, v_visibility);
         }
    </script>
</head>

<body onload="main()">
    <canvas id="renderCanvas"></canvas>
    
    
<script src="src/main.js"></script>
<script src="src/renderEngine/displayManager.js"></script>
<script src="src/renderEngine/loader.js"></script>
<script src="src/renderEngine/entityRenderer.js"></script>
<script src="src/renderEngine/masterRenderer.js"></script>
<script src="src/renderEngine/terrainRenderer.js"></script>
<script src="src/renderEngine/models/rawModel.js"></script>
<script src="src/renderEngine/models/texturedModel.js"></script>
<script src="src/shaders/shaderProgram.js"></script>
<script src="src/shaders/terrainShader.js"></script>
<script src="src/shaders/staticShader.js"></script>
<script src="src/textures/modelTexture.js"></script>
<script src="src/textures/terrainTexture.js"></script>
<script src="src/textures/terrainTexturePack.js"></script>
<script src="scripts/gl-matrix.js"></script>
<script src="src/entities/entity.js"></script>
<script src="src/toolbox/maths.js"></script>
<script src="src/entities/camera.js"></script>
<script src="src/toolbox/keyboard.js"></script>
<script src="src/toolbox/hashTable.js"></script>
<script src="src/renderEngine/objLoader.js"></script>
<script src="src/entities/light.js"></script>
<script src="src/entities/terrain.js"></script>
</body>

</html>