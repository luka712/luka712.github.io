<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Generating Terrain (Part 2) - Hill Algorithm | luka712 blog</title><meta name="description" content="In part 2 of Terraing Generator posts we go through terrain generation and hill algorithms."><meta name="generator" content="luka712 blog"><meta name="author" content="Luka Erkapic"><meta name="keywords" content="sjaak van den berg, svdb, bitcoin, crypto, payment, integration, bitcoins, wordpress, betaling, webshop, front end, design, ontwerp, developer"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="stylesheet" type="text/css" href="/styles/style.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160x160.png"><link rel="icon" type="image/png" sizes="192x192" href="/images/favicon-192x192.png"><meta name="msapplication-TileColor" content="#121315"><meta name="msapplication-TileImage" content="/images/mstile-144x144.png"></head><body itemscope itemtype="https://schema.org/WebPage" onload="onLoad()"><header itemscope itemtype="https://schema.org/WPHeader"><h1><a href="/" alt="luka712 blog" title="luka712 blog" itemprop="headline" class="header">luka712 blog</a></h1><p itemprop="description"></p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/" alt="Home" title="Home" itemprop="url" class="header">Home</a></li><li itemprop="name"><a href="/About" alt="About" title="About" itemprop="url" class="header">About</a></li></ul></nav><div id="render-space"><canvas id="render-canvas"></canvas></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline">Generating Terrain (Part 2) - Hill Algorithm</h1><span class="post-meta">Published on<time itemprop="datePublished" datetime="2018-06-23T22:00:00.000Z"> Sunday, June 24th 2018 at 0:00</time><br>Last updated on<time itemprop="dateModified" datetime="2018-06-23T22:00:00.000Z"> Sunday, July 8th 2018 at 18:13</time></span><h5 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h5><p>In <a href="/2018/06/16/Terrain/">part 1</a> of this post we learned a bit about BabylonJS and building blocks for our terrain (vertices,indices,colors). Not it’s time to put that to use and create terrain. For that we are going to first create flat terrain and then use algorithm for creating some hills. With algorithm being nothing but a simple function.</p>
<p>Last time we have left of with this code:</p>
<p>Index file: </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/babylonjs/3.2.0/babylon.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>BabylonJS - Terrain<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    #renderCanvas&#123;</span></span><br><span class="line"><span class="undefined">        width: 100%;</span></span><br><span class="line"><span class="undefined">        height: 100%;</span></span><br><span class="line"><span class="undefined">        background-color: cornflowerblue;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    html, body &#123;</span></span><br><span class="line"><span class="undefined">        margin: 0px;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"renderCanvas"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>and JavaScript file:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"renderCanvas"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> engine = <span class="keyword">new</span> BABYLON.Engine(canvas, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createScene</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> scene = <span class="keyword">new</span> BABYLON.Scene(engine);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> camera = <span class="keyword">new</span> BABYLON.TargetCamera(<span class="string">'camera'</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">-5</span>), scene);</span><br><span class="line">        camera.setTarget(BABYLON.Vector3.Zero());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Change position and direction of light</span></span><br><span class="line">        <span class="keyword">var</span> light = <span class="keyword">new</span> BABYLON.DirectionalLight(<span class="string">'light1'</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>), scene);</span><br><span class="line">        light.position = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> customMesh = <span class="keyword">new</span> BABYLON.Mesh(<span class="string">"custom"</span>, scene);</span><br><span class="line">        <span class="keyword">var</span> material = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">"myMaterial"</span>, scene);</span><br><span class="line">        material.specularColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        customMesh.material = material;</span><br><span class="line">        <span class="keyword">var</span> vertexData = <span class="keyword">new</span> BABYLON.VertexData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> face = createFace([<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>], [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>], [<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>], [<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>], index, [<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>]);;</span><br><span class="line">        vertexData.positions = face.positions;</span><br><span class="line">        vertexData.indices = face.indices;</span><br><span class="line">        vertexData.colors = face.colors;</span><br><span class="line">        vertexData.normals = [];</span><br><span class="line">        BABYLON.VertexData.ComputeNormals(vertexData.positions, vertexData.indices, vertexData.normals);</span><br><span class="line"></span><br><span class="line">        vertexData.applyToMesh(customMesh);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> scene;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createFace</span>(<span class="params">topLeft, bottomLeft, bottomRight, topRight, i, color</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> v1 = topLeft;</span><br><span class="line">        <span class="keyword">var</span> v2 = bottomLeft;</span><br><span class="line">        <span class="keyword">var</span> v3 = bottomRight;</span><br><span class="line">        <span class="keyword">var</span> v4 = topRight;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// first triangle </span></span><br><span class="line">        <span class="keyword">var</span> triangle1 = [i, i+<span class="number">1</span>, i+<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// second triangle</span></span><br><span class="line">        <span class="keyword">var</span> triangle2 = [i+<span class="number">2</span>, i+<span class="number">3</span>, i];</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            positions: v1.concat(v2, v3, v4),</span><br><span class="line">            indices: triangle1.concat(triangle2),</span><br><span class="line">            colors: color.concat(color, color, color),</span><br><span class="line">            i: i + <span class="number">4</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> scene = createScene();</span><br><span class="line"></span><br><span class="line">    engine.runRenderLoop(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        scene.render();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        engine.resize();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="Create-Terrain-Data"><a href="#Create-Terrain-Data" class="headerlink" title="Create Terrain Data"></a>Create Terrain Data</h5><p>First some bad news, <em>createFace</em> function from part1 is not going to be used for terrain, instead new  <em>createTerrainData</em> function is going to be used.<br>Why you might ask ?</p>
<p>Well, <em>createFace</em> function will duplicate vertex and indices data.</p>
<p>If we were to create 1 face, it would look something like this with all the vertices and data.</p>
<p><img src="/images/2/image1.png" style="width:50%"></p>
<p>So there are 2 triangles for 1 face, one of them would be triangle (v0,v1,v2) with indices (i0,i1,i2), the other one would be (v2,v3,v0) with indices (i3,i4,i5) defining it.</p>
<p>And this seems right, but terrain will be made with multiple squares and duplicating vertexes would result in lot larger model.</p>
<p><img src="/images/2/image2.png" style="width:50%"></p>
<p>As you can see v3 and v4 share same position . Same is true for v2 and v5. </p>
<p>This should be done without any vertices sharing positions.<br>Let’s start by creating <em>createTerrainData</em> function;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTerrainData</span>(<span class="params">width, length</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span>,</span><br><span class="line">        positions = [],</span><br><span class="line">        indices = [],</span><br><span class="line">        colors = [];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// add vertices</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> z = <span class="number">0</span>; z &lt;= length; z++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="number">0</span>; x &lt;= width; x++) &#123;</span><br><span class="line">            positions.push(x);</span><br><span class="line">            positions.push(<span class="number">0</span>);</span><br><span class="line">            positions.push(z);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">            positions: positions,</span><br><span class="line">            indices: indices,</span><br><span class="line">            colors: colors</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>We push x,y,z into positions array. Y is set to zero, since we’re going to deal with height later. If we would to imagine x as rows(width of terrain) and z as columns(length of terrain) we would end up with this for 3x3 terrain. </p>
<p><img src="/images/2/image3.png" style="width:50%"></p>
<p>When it comes to indices, finding correct ones  is bit more complicated, still not hard though. We already imagined our terrain as grid, now we should simply loop through it and get indices for each quad. After that simply create two triangles out of them to represent quad. Add this right after loops for vertices.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> numOfIndicesInRow = width + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> z = <span class="number">0</span>; z &lt; length; z++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; width; x++) &#123;</span><br><span class="line">        <span class="keyword">var</span> bottomLeft = x + z * numOfIndicesInRow;</span><br><span class="line">        <span class="keyword">var</span> bottomRight = x + <span class="number">1</span> + z * numOfIndicesInRow;</span><br><span class="line">        <span class="keyword">var</span> topLeft = x + (z + <span class="number">1</span>) * numOfIndicesInRow;</span><br><span class="line">        <span class="keyword">var</span> topRight = x + <span class="number">1</span> + (z + <span class="number">1</span>) * numOfIndicesInRow  </span><br><span class="line">        <span class="comment">// first triangle</span></span><br><span class="line">        indices.push(topLeft);</span><br><span class="line">        indices.push(bottomLeft);</span><br><span class="line">        indices.push(bottomRight);</span><br><span class="line">        <span class="comment">// second triangle</span></span><br><span class="line">        indices.push(bottomRight);</span><br><span class="line">        indices.push(topRight);</span><br><span class="line">        indices.push(topLeft);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s break this down with example. I’m using quadrant where x is 2 and z is 1 just as proof and to make code clear.</p>
<p><img src="/images/2/image4.png"></p>
<p>With indices in place, we only need to fill color data in. For now we just create green color for each vertex.<br>Add this code right after loop for indices.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= positions.length / <span class="number">3</span>;i++)&#123;</span><br><span class="line">    colors.push(<span class="number">0</span>);</span><br><span class="line">    colors.push(<span class="number">1</span>);</span><br><span class="line">    colors.push(<span class="number">0</span>);</span><br><span class="line">    colors.push(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Camera is off the terrain, so let’s adjust camera and light a bit to see whole terrain.<br>Change previous lines to </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> camera = <span class="keyword">new</span> BABYLON.TargetCamera(<span class="string">'camera'</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>), scene);</span><br><span class="line">camera.setTarget(BABYLON.Vector3.Zero())<span class="comment">// Change position and direction of light</span></span><br><span class="line"><span class="keyword">var</span> light = <span class="keyword">new</span> BABYLON.DirectionalLight(<span class="string">'light1'</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>), scene);</span><br><span class="line">light.position = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>Next up is calling <em>createTerrainData</em> and adding terrain. Delete code after <code>var vertexData = new BABYLON.VertexData();</code> right up to <code>return scene</code> and add this instead.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">var</span> terrainData = createTerrainData(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line">vertexData.positions = terrainData.positions;</span><br><span class="line">vertexData.indices = terrainData.indices;</span><br><span class="line">vertexData.colors = terrainData.colors;</span><br><span class="line">vertexData.normals = [];</span><br><span class="line">BABYLON.VertexData.ComputeNormals(vertexData.positions, vertexData.indices, vertexData.normals);</span><br><span class="line"></span><br><span class="line">vertexData.applyToMesh(customMesh);</span><br><span class="line"></span><br><span class="line">customMesh.translate(<span class="keyword">new</span> BABYLON.Vector3(<span class="number">-20</span>, <span class="number">0</span>, <span class="number">-15</span>), <span class="number">1</span>, BABYLON.Space.WORLD);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Only last line is really something that we haven’t seen up until now. That just moving terrain position a bit, to get it better aligned with camera.</p>
<p>One intresting line that you can use would be <code>customMesh.material.wireframe = true;</code> somewhere after mesh material assignment to see terrain in wireframe mode. I’m going to use that for couple of example images. If you followed everything correctly, you have something like this now.</p>
<p><img src="/images/2/image11.png" style="width:50%"></p>
<p>We can finally add up some hills to terrain. Start by creating a constructor function for hills. Add this right after <em>createTerrainData</em> function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hill</span>(<span class="params">x,z,height, radius</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.x = x;</span><br><span class="line">    <span class="keyword">this</span>.z = z;</span><br><span class="line">    <span class="keyword">this</span>.height = height;</span><br><span class="line">    <span class="keyword">this</span>.radius = radius;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>X and Z are simply positions on terrain map. Height is naturally height of terrain at it’s center. Radius says how wide and long terrain will be.</p>
<p>Next, add this code after indices for loops, but before color loops.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hills = [</span><br><span class="line">         <span class="keyword">new</span> Hill(<span class="number">15</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">5</span>),</span><br><span class="line">         <span class="keyword">new</span> Hill(<span class="number">5</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">3</span>),</span><br><span class="line">         <span class="keyword">new</span> Hill(<span class="number">20</span>, <span class="number">25</span>, <span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">     ]</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= positions.length; i += <span class="number">3</span>) &#123;</span><br><span class="line">     <span class="keyword">var</span> x = positions[i];</span><br><span class="line">     <span class="keyword">var</span> y = positions[i + <span class="number">1</span>];</span><br><span class="line">     <span class="keyword">var</span> z = positions[i + <span class="number">2</span>];</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; hills.length; j++) &#123;</span><br><span class="line">         <span class="keyword">var</span> hill = hills[j];</span><br><span class="line">         <span class="keyword">var</span> dx = hill.x - x;</span><br><span class="line">         <span class="keyword">var</span> dz = hill.z - z;</span><br><span class="line">         <span class="keyword">var</span> distance = <span class="built_in">Math</span>.sqrt(dx * dx + dz * dz) / hill.radius;</span><br><span class="line">         <span class="keyword">var</span> distanceReversed = <span class="number">1</span> - distance;</span><br><span class="line">         <span class="keyword">if</span> (distanceReversed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">var</span> newY = hill.height * distanceReversed;</span><br><span class="line">             <span class="keyword">if</span> (newY &gt; positions[i + <span class="number">1</span>]) &#123;</span><br><span class="line">                 positions[i + <span class="number">1</span>] = newY;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><em>Hills</em> is nothing but simple array of multiple hills. Having terrain with one hill would be quite boring.<br>Next we loop throught all positions and get x,y,z components. Make sure that <em>i</em> is incremented by 3 <code>i+=3</code>.<br>After that we loop throught hills. Now it gets interesting.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dx = hill.x - x;</span><br><span class="line"><span class="keyword">var</span> dz = hill.z - z;</span><br><span class="line"><span class="keyword">var</span> distance = <span class="built_in">Math</span>.sqrt(dx * dx + dz * dz) / hill.radius;</span><br><span class="line"><span class="keyword">var</span> distanceReversed = <span class="number">1</span> - distance;</span><br><span class="line"><span class="keyword">if</span> (distanceReversed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> newY = hill.height * distanceFromHill;</span><br><span class="line">    <span class="keyword">if</span> (newY &gt; positions[i + <span class="number">1</span>]) &#123;</span><br><span class="line">        positions[i + <span class="number">1</span>] = newY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>dx</em> is delta x, which is difference between x component for hill and x component of vertex that we are currently checking. Same is true for z.<br>Next line is distance formula, otherwise known as [Pythagorean theorem(<a href="https://en.wikipedia.org/wiki/Pythagorean_theorem)]" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Pythagorean_theorem)]</a> <em>c² = a² + b²</em>, or as shown in code <code>Math.sqrt(dx * dx + dy * dy)</code>. If this is not clear it’s going to be explained in a bit.<br>Next, distance is divided by hill radius in order to get value between 0 and 1, one being furthest from center.<br><em>distanceReversed</em> represents, well distance reversed and that value is used to change height if it’s higher then 0.<br>Also it is used for getting height of hill. </p>
<p>Last line just checks if <em>newY</em> is higher then already assigned height, if so we take new Y value.</p>
<p>Let’s break it down a bit.</p>
<p> First part is getting a distance between two points. I am using points (1,1) for hill H and (3,2) for vertex V.</p>
<p> <img id="distance" src="/images/2/image5.png" style="width:50%"></p>
<p>Hope that this makes it clear. If not try watching <a href="https://www.youtube.com/watch?v=nyZuite17Pc" target="_blank" rel="noopener">this</a> or any other resource about distance formula.<br>Next part is getting Y value, which is just height multipled by distance. First example just demonstrates how we can imagine hill,  with radius representing nothing more but a distance.</p>
<p> <img src="/images/2/image6.png" style="width:70%"></p>
<p>  Second example is bit more interesting as it shows height as simple linear function <em>Y(D) = H </em> (1 - D)*. As you can see, as distance increases, height decreases and that’s excatly how we do slope.</p>
<p>Try to move out camera a bit. Set camera line to <code>var camera = new BABYLON.FreeCamera(&#39;camera&#39;, new BABYLON.Vector3(25, 15, 35), scene);</code> and feel free to enjoy some hills.</p>
<p><img src="/images/2/image7.png" style="width:50%"></p>
<p>Well actually, those are some ugly looking spiky hills. Now math comes to rescue, as you have seen our hill is represented by a linear function. But why should it be linear ?<br>What if we were to use quadratic function like <em>Y(D) = H </em> (1 - D)²*. What about adding <a href="https://en.wikipedia.org/wiki/Sine_wave" target="_blank" rel="noopener">sin</a> or <a href="https://en.wikipedia.org/wiki/Sine_wave" target="_blank" rel="noopener">cos</a> waves.<br>Good thing is, we can do just about any crazy thing with defining some functions. </p>
<p>We are going to create seperate function for each hill and pass that function as parameter to Hill constructor. What do I mean excatlye ?  Let’s actually  expand <em>Hill</em> constructor function with <em>heightCallback</em> function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hill</span>(<span class="params">x, z, height, radius, heightCallback</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.x = x;</span><br><span class="line">      <span class="keyword">this</span>.z = z;</span><br><span class="line">      <span class="keyword">this</span>.height = height;</span><br><span class="line">      <span class="keyword">this</span>.radius = radius;</span><br><span class="line">      <span class="keyword">this</span>.heightCallback = heightCallback;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Now we can go crazy with our hills declarations, like so:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hills = [</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">15</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>.height * <span class="built_in">Math</span>.pow(distance, <span class="number">2</span>);</span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">25</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>.height *  <span class="built_in">Math</span>.sin(distance * <span class="number">40</span>);</span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">5</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>.height * <span class="built_in">Math</span>.cos(distance * <span class="number">300</span>);</span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">25</span>, <span class="number">25</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="built_in">Math</span>.random() * <span class="number">5</span>;</span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">10</span>, <span class="number">25</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">var</span> v = <span class="built_in">parseInt</span>(distance * <span class="number">10</span>) / <span class="number">10</span>;</span><br><span class="line">              <span class="keyword">if</span> (v &lt; <span class="number">0.6</span>) <span class="keyword">return</span> <span class="keyword">this</span>.height * <span class="number">0.5</span>;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">this</span>.height;</span><br><span class="line">          &#125;)</span><br><span class="line">      ]</span><br></pre></td></tr></table></figure>
<p>Next, in loop where we change height line <code>var newHeight = hill.height * distanceFromHill;</code> should be changed to<br><code>var newHeight = hill.heightCallback(distanceReversed);</code> so that it actually uses new callback function. After that refresh browser or try running index file.</p>
<p><img src="/images/2/image8.png" style="width:50%"></p>
<p>One last thing to do is just to create some colors for higher points. We already have loop for colors, so just change it with this one.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= positions.length; i += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> y = positions[i + <span class="number">1</span>];</span><br><span class="line">   <span class="keyword">if</span>(y &gt; <span class="number">5</span>)&#123;</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (y &gt; <span class="number">4</span>) &#123;</span><br><span class="line">       colors.push(<span class="number">0.6</span>);</span><br><span class="line">       colors.push(<span class="number">0.6</span>);</span><br><span class="line">       colors.push(<span class="number">0.6</span>);</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (y &gt; <span class="number">1.5</span>) &#123;</span><br><span class="line">       colors.push(<span class="number">0.5</span>);</span><br><span class="line">       colors.push(<span class="number">0.2</span>);</span><br><span class="line">       colors.push(<span class="number">0.1</span>);</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       colors.push(<span class="number">0</span>);</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">       colors.push(<span class="number">0</span>);</span><br><span class="line">       colors.push(<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Colors loop is quite straightforward and shouldn’t be anything new by now.<br>Back to hills, those might look a bit crazy and not really real, so I have changed mine to something better to work with.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hills = [</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">16</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="number">22</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="built_in">Math</span>.random() * <span class="number">0.5</span>;</span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">15</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>.height * <span class="built_in">Math</span>.pow(distance, <span class="number">2</span>);</span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">5</span>, <span class="number">23</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>.height * <span class="built_in">Math</span>.sin(distance * <span class="built_in">Math</span>.PI);</span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="keyword">new</span> Hill(<span class="number">15</span>, <span class="number">7.5</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>.height * <span class="built_in">Math</span>.pow(distance, <span class="number">1.5</span>);</span><br><span class="line">          &#125;)</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>If you have wireframe mode enabled, change into solid mode by settings wireframe to false<br><code>customMesh.material.wireframe = false;</code>. And we get this.</p>
<p><img src="/images/2/image9.png" style="width:50%"></p>
<p>It does look pretty decent, but it doesn’t have that low poly feel to it, and that is due to shading and normals. Right now it is using different normal vector for every vertex within triangle. Flat shading is done by using same normal vertex for each vertex within triangle. Add this line <code>customMesh.convertToFlatShadedMesh();</code> before <code>return scene</code> in <em>createScene</em> function. Now it should have that low poly look.</p>
<p><img src="/images/2/image10.png" style="width:50%"></p>
<p>Truth is <em>convertToFlatShadedMesh()</em> adds additional vertexes and normals to achieve that look, so it’s not perfect, but it’s better then us creating additonal vertexes. There is a way to achieve flat shading without additional vertexes, in fact multiple ways, but that would require shader coding, which is topic on it’s own and is out of scope for this post. ( this would seriously make this post very very very long).</p>
<p>Hopy you enjoyed it, in part 3 we’re going to add some 3d models. All code for this tutorial is available on <a href="https://github.com/luka712/BabylonJS---Terrain-Generation/tree/master/Part%202" target="_blank" rel="noopener">GitHub</a>.</p>
</article></main><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/babylonjs/3.3.0-alpha.12/babylon.js"></script><script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script><script src="https://cdn.jsdelivr.net/npm/babylonjs-gui@3.3.0/babylon.gui.min.js"></script><script src="/scripts/index.js" type="text/javascript"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-121717766-1');ga('send','pageview');</script></body></html>